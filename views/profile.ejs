<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile | HealthCare+</title>
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="/images/medical-icon.png">
</head>
<body>

  <div class="profile-container">
    
    <!-- Header -->
    <div class="profile-header">
      <h1><i class="fas fa-user-circle"></i> My Profile</h1>
      <div class="role-badge">
        <i class="fas fa-<%= user.role === 'doctor' ? 'user-md' : 'user-injured' %>"></i>
        <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
      </div>
    </div>

    <!-- Success/Error Messages (if using flash) -->
 
    
 
    <!-- Profile Card -->
    <div class="profile-card">
      
      

      <!-- Main Form -->
      <form method="POST" 
            action="/profile" 
            enctype="multipart/form-data"
            id="profileForm"
            class="profile-form">
            <!-- Profile Photo Section -->
      <div class="photo-section">
        <div class="current-photo">
          <% if (user.profilePhoto && user.profilePhoto !== '' && user.profilePhoto !== 'default') { %>
            <div class="photo-preview-container">
              <img src="<%= user.profilePhoto %>" 
                   alt="Profile Photo" 
                   class="photo-preview"
                   id="photoPreview">
              <div class="photo-overlay" onclick="document.getElementById('profilePhoto').click()">
                <i class="fas fa-camera"></i>
              </div>
            </div>
          <% } else { %>
            <div class="photo-preview-container" onclick="document.getElementById('profilePhoto').click()">
              <div class="default-photo">
                <i class="fas fa-user"></i>
              </div>
              <div class="photo-overlay">
                <i class="fas fa-camera"></i>
              </div>
            </div>
          <% } %>
          <p class="photo-hint">
            <i class="fas fa-info-circle"></i> Click photo to upload new one
          </p>
        </div>
        
        <div class="photo-info">
          <h3><i class="fas fa-camera"></i> Profile Photo</h3>
          <div class="file-upload-wrapper">
            <input type="file" 
                   name="profilePhoto" 
                   id="profilePhoto"
                   accept="image/*"
                   class="file-input"
                   onchange="previewPhoto(event)">
            <label for="profilePhoto" class="file-label">
              <i class="fas fa-cloud-upload-alt"></i>
              <span>Choose a photo...</span>
            </label>
            <div class="file-info" id="fileInfo"></div>
            <p class="file-hint">
              <i class="fas fa-info-circle"></i> 
              Max size: 5MB â€¢ Formats: JPG, PNG, GIF
            </p>
          </div>
        </div>
      </div>
        
        <!-- Hidden current photo for reference -->
        <input type="hidden" name="currentPhoto" value="<%= user.profilePhoto || '' %>">

        <!-- Basic Information -->
        <div class="form-section">
          <h3><i class="fas fa-user"></i> Basic Information</h3>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="name">
                <i class="fas fa-user"></i> Full Name
              </label>
              <input type="text" 
                     id="name"
                     name="name" 
                     value="<%= user.name || '' %>"
                     placeholder="Enter your full name"
                     required>
            </div>

            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i> Email Address
              </label>
              <input type="email" 
                     id="email"
                     value="<%= user.email || '' %>"
                     disabled
                     class="disabled-field">
              <p class="field-hint">
                <i class="fas fa-lock"></i> Email cannot be changed
              </p>
            </div>

            <div class="form-group">
              <label for="contact">
                <i class="fas fa-phone"></i> Contact Number
              </label>
              <input type="tel" 
                     id="contact"
                     name="contact" 
                     value="<%= user.contact || '' %>"
                     placeholder="Enter contact number">
            </div>
          </div>
        </div>

        <!-- Role-Specific Information -->
        <% if (user.role === "doctor") { %>
          <div class="form-section doctor-section">
            <h3><i class="fas fa-user-md"></i> Professional Details</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="degree">
                  <i class="fas fa-graduation-cap"></i> Medical Degree
                </label>
                <input type="text" 
                       id="degree"
                       name="degree" 
                       value="<%= user.degree || '' %>"
                       placeholder="e.g., MBBS, MD, MS">
              </div>

              <div class="form-group">
                <label for="specialization">
                  <i class="fas fa-stethoscope"></i> Specialization
                </label>
                <input type="text" 
                       id="specialization"
                       name="specialization" 
                       value="<%= user.specialization || '' %>"
                       placeholder="e.g., Cardiology, Neurology">
              </div>

              <div class="form-group">
                <label for="experience">
                  <i class="fas fa-briefcase"></i> Experience (Years)
                </label>
                <input type="number" 
                       id="experience"
                       name="experience" 
                       value="<%= user.experience || '' %>"
                       placeholder="e.g., 5"
                       min="0"
                       max="60">
              </div>

              <div class="form-group full-width">
                <label for="about">
                  <i class="fas fa-file-medical-alt"></i> About & Practice Details
                </label>
                <textarea id="about"
                          name="about"
                          placeholder="Describe your practice, consultation hours, expertise, etc."
                          rows="4"><%= user.about || '' %></textarea>
                <div class="char-counter" id="aboutCounter">
                  <%= (user.about || '').length %>/500 characters
                </div>
              </div>

              <div class="form-group full-width">
                <label for="clinicAddress">
                  <i class="fas fa-map-marker-alt"></i> Clinic Address
                </label>
                <textarea id="clinicAddress"
                          name="clinicAddress"
                          placeholder="Enter complete clinic address"
                          rows="3"><%= user.clinicAddress || '' %></textarea>
              </div>
            </div>
          </div>
        <% } %>

        <% if (user.role === "patient") { %>
          <div class="form-section patient-section">
            <h3><i class="fas fa-user-injured"></i> Health Information</h3>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="age">
                  <i class="fas fa-birthday-cake"></i> Age
                </label>
                <input type="number" 
                       id="age"
                       name="age" 
                       value="<%= user.age || '' %>"
                       placeholder="Enter age"
                       min="0"
                       max="120">
              </div>

              <div class="form-group">
                <label for="bloodGroup">
                  <i class="fas fa-tint"></i> Blood Group
                </label>
                <select id="bloodGroup" name="bloodGroup" class="form-select">
                  <option value="">Select Blood Group</option>
                  <option value="A+" <%= user.bloodGroup === 'A+' ? 'selected' : '' %>>A+</option>
                  <option value="A-" <%= user.bloodGroup === 'A-' ? 'selected' : '' %>>A-</option>
                  <option value="B+" <%= user.bloodGroup === 'B+' ? 'selected' : '' %>>B+</option>
                  <option value="B-" <%= user.bloodGroup === 'B-' ? 'selected' : '' %>>B-</option>
                  <option value="O+" <%= user.bloodGroup === 'O+' ? 'selected' : '' %>>O+</option>
                  <option value="O-" <%= user.bloodGroup === 'O-' ? 'selected' : '' %>>O-</option>
                  <option value="AB+" <%= user.bloodGroup === 'AB+' ? 'selected' : '' %>>AB+</option>
                  <option value="AB-" <%= user.bloodGroup === 'AB-' ? 'selected' : '' %>>AB-</option>
                </select>
              </div>

              <div class="form-group">
                <label for="emergencyContact">
                  <i class="fas fa-phone-alt"></i> Emergency Contact
                </label>
                <input type="tel" 
                       id="emergencyContact"
                       name="emergencyContact" 
                       value="<%= user.emergencyContact || '' %>"
                       placeholder="Emergency contact number">
              </div>

              <div class="form-group full-width">
                <label for="address">
                  <i class="fas fa-home"></i> Address
                </label>
                <textarea id="address"
                          name="address"
                          placeholder="Enter your complete address"
                          rows="3"><%= user.address || '' %></textarea>
              </div>

              <!-- Additional Health Fields -->
              <div class="form-group">
                <label for="height">
                  <i class="fas fa-ruler-vertical"></i> Height (cm)
                </label>
                <input type="number" 
                       id="height"
                       name="height" 
                       value="<%= user.height || '' %>"
                       placeholder="Height in cm"
                       min="50"
                       max="250">
              </div>

              <div class="form-group">
                <label for="weight">
                  <i class="fas fa-weight"></i> Weight (kg)
                </label>
                <input type="number" 
                       id="weight"
                       name="weight" 
                       value="<%= user.weight || '' %>"
                       placeholder="Weight in kg"
                       min="10"
                       max="300">
              </div>

              <div class="form-group full-width">
                <label for="allergies">
                  <i class="fas fa-allergies"></i> Known Allergies
                </label>
                <input type="text" 
                       id="allergies"
                       name="allergies" 
                       value="<%= user.allergies || '' %>"
                       placeholder="e.g., Penicillin, Peanuts, Dust">
              </div>

              <div class="form-group full-width">
                <label for="chronicConditions">
                  <i class="fas fa-heartbeat"></i> Chronic Conditions
                </label>
                <input type="text" 
                       id="chronicConditions"
                       name="chronicConditions" 
                       value="<%= user.chronicConditions || '' %>"
                       placeholder="e.g., Diabetes, Hypertension, Asthma">
              </div>
            </div>
          </div>
        <% } %>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="saveBtn">
            <i class="fas fa-save"></i> Save Profile
          </button>
          
          <a href="/dashboard" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
          
          <button type="button" class="btn btn-danger" onclick="showDeleteModal()">
            <i class="fas fa-trash-alt"></i> Delete Profile
          </button>
        </div>
      </form>
    </div>

    <!-- Last Updated Info -->
    <div class="profile-info-footer">
      <p>
        <i class="fas fa-shield-alt"></i> Your data is protected with 256-bit encryption
      </p>
      <% if (user.updatedAt) { %>
        <p class="last-updated">
          <i class="fas fa-clock"></i> 
          Last updated: <%= new Date(user.updatedAt).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %>
        </p>
      <% } %>
    </div>

  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Delete Profile</h3>
      </div>
      <div class="modal-body">
        <p><strong>Warning:</strong> This action is permanent and cannot be undone.</p>
        <p>All your data will be permanently deleted:</p>
        <ul>
          <li>Personal information and profile</li>
          <li>Medical records and history</li>
          <li>Appointment history</li>
          <li>Messages and notifications</li>
          <li>Connection with doctors/patients</li>
        </ul>
        <p>Are you sure you want to proceed?</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="hideDeleteModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <form method="POST" action="/profile/delete" class="inline-form">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Delete Permanently
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Photo Preview Functionality
    function previewPhoto(event) {
      const file = event.target.files[0];
      const fileInfo = document.getElementById('fileInfo');
      const photoPreview = document.getElementById('photoPreview');
      const defaultPhoto = document.querySelector('.default-photo');
      
      // Reset file info
      fileInfo.textContent = '';
      fileInfo.className = 'file-info';
      
      if (file) {
        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          fileInfo.textContent = 'File size exceeds 5MB limit';
          fileInfo.classList.add('error');
          event.target.value = '';
          return;
        }
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          fileInfo.textContent = 'Please select a valid image file (JPG, PNG, GIF, or WebP)';
          fileInfo.classList.add('error');
          event.target.value = '';
          return;
        }
        
        // Update file info
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        fileInfo.textContent = `Selected: ${file.name} (${fileSize} MB)`;
        fileInfo.classList.add('success');
        
        // Preview image
        const reader = new FileReader();
        reader.onload = function(e) {
          if (defaultPhoto) {
            defaultPhoto.style.display = 'none';
          }
          
          if (!photoPreview) {
            // Create new preview image
            const container = document.querySelector('.photo-preview-container');
            const newPreview = document.createElement('img');
            newPreview.id = 'photoPreview';
            newPreview.className = 'photo-preview';
            newPreview.alt = 'Profile Preview';
            newPreview.src = e.target.result;
            
            const overlay = container.querySelector('.photo-overlay');
            container.insertBefore(newPreview, overlay);
          } else {
            photoPreview.src = e.target.result;
            photoPreview.style.display = 'block';
          }
        };
        reader.readAsDataURL(file);
      }
    }

    // Character counter for textareas
    document.addEventListener('DOMContentLoaded', function() {
      const aboutTextarea = document.getElementById('about');
      const aboutCounter = document.getElementById('aboutCounter');
      
      if (aboutTextarea && aboutCounter) {
        aboutTextarea.addEventListener('input', function() {
          const length = this.value.length;
          aboutCounter.textContent = `${length}/500 characters`;
          
          // Update counter color
          aboutCounter.className = 'char-counter';
          if (length > 450) {
            aboutCounter.classList.add('warning');
          } else if (length > 400) {
            aboutCounter.classList.add('info');
          }
        });
      }
      
      // Form validation
      const form = document.getElementById('profileForm');
      const saveBtn = document.getElementById('saveBtn');
      
      if (form) {
        form.addEventListener('submit', function(e) {
          // Show loading state
          saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
          saveBtn.disabled = true;
          
          // Form will submit normally
        });
      }
      
      // Click photo to trigger file input
      document.querySelector('.photo-preview-container')?.addEventListener('click', function() {
        document.getElementById('profilePhoto').click();
      });
    });

    // Modal Functions
    function showDeleteModal() {
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function hideDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }

    // Close modal on outside click
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('deleteModal');
      if (event.target === modal) {
        hideDeleteModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideDeleteModal();
      }
    });

    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      .photo-preview-container:hover {
        animation: pulse 0.5s ease;
      }
      
      .profile-card {
        animation: fadeIn 0.6s ease-out;
      }
      
      .form-group {
        animation: slideIn 0.5s ease-out;
        animation-fill-mode: both;
      }
      
      .form-group:nth-child(1) { animation-delay: 0.1s; }
      .form-group:nth-child(2) { animation-delay: 0.2s; }
      .form-group:nth-child(3) { animation-delay: 0.3s; }
      .form-group:nth-child(4) { animation-delay: 0.4s; }
    `;
    document.head.appendChild(style);
  </script>

</body>
</html>